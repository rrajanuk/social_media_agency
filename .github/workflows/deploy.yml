name: Deploy to Contabo VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install + Build
        run: |
          # Install and build frontend
          npm ci
          npm install --include=dev
          npm run build   # Frontend at root → dist/
          
          # Install and build backend (needs devDeps for TypeScript)
          cd backend
          npm ci
          npm run build   # Backend → backend/dist/

      - name: Deploy to VPS
        uses: burnett01/rsync-deployments@7.0.0
        with:
          switches: -avzr --delete --exclude='backend/.env' --exclude='backend/data'
          path: .
          remote_path: /var/www/social-media-agency/
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Restart services
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/social-media-agency
            mkdir -p backend/data && chmod 755 backend/data
            rm -rf public && mkdir public && cp -r dist/* public/
            cd backend
            
            # Create .env if it doesn't exist
            if [ ! -f .env ]; then
              echo "Creating .env from template..."
              cp .env.example .env
              echo ".env created"
            fi
            
            # Always update secrets (whether .env existed or not)
            # Use '#' as a separator in sed to avoid issues with special characters in the secret
            sed -i "s#ADMIN_API_KEY=.*#ADMIN_API_KEY=${{ secrets.ADMIN_API_KEY }}#" .env
            sed -i "s/NODE_ENV=.*/NODE_ENV=production/" .env
            echo ".env file updated."

            # Verification step
            echo "Verifying ADMIN_API_KEY..."
            if grep -q "your-secure-api-key-here" .env; then
              echo "Error: ADMIN_API_KEY was not updated correctly!"
              exit 1
            fi
            echo "ADMIN_API_KEY successfully updated."
            grep 'ADMIN_API_KEY' .env
            
            npm ci --omit=dev
            pm2 restart social-agency-api || pm2 start dist/server.js --name social-agency-api
            pm2 save
            nginx -t && systemctl reload nginx
            echo "Deployed successfully at $(date)"