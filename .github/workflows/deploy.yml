name: Deploy to Contabo VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install + Build
        run: |
          npm ci
          npm install --include=dev
          npm run build   # Frontend at root → dist/
          cd backend
          npm ci --only=production
          npm run build   # Backend → backend/dist/

      - name: Deploy to VPS
        uses: burnett01/rsync-deployments@7.0.0
        with:
          switches: -avzr --delete --exclude='backend/.env' --exclude='backend/data'
          path: .
          remote_path: /var/www/social-media-agency/
          remote_host: 217.216.48.189
          remote_user: root
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Restart services
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: 217.216.48.189
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/social-media-agency
            mkdir -p backend/data && chmod 755 backend/data
            rm -rf public && mkdir public && cp -r dist/* public/
            cd backend
            pm2 restart social-agency-api || pm2 start dist/server.js --name social-agency-api
            pm2 save
            nginx -t && systemctl reload nginx
            echo "Deployed successfully at $(date)"