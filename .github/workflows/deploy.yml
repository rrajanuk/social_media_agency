name: Deploy to Contabo VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Backend Dependencies
        working-directory: backend
        run: npm ci

      - name: Build Backend
        working-directory: backend
        run: npm run build

      - name: Deploy to VPS
        uses: burnett01/rsync-deployments@7.0.0
        with:
          switches: -avzr --delete --exclude='backend/.env' --exclude='backend/data'
          rsh: ssh -o StrictHostKeyChecking=no
          path: .
          remote_path: /var/www/social-media-agency/
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Restart services
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/social-media-agency
            mkdir -p backend/data && chmod 755 backend/data
            rm -rf public && mkdir public
            cp index.html script.js apple-touch-icon.svg favicon.svg favicon.ico public/
            cp -r images/ public/ || true
            
            # Fix nginx to serve from public/ instead of dist/
            if grep -q 'root /var/www/social-media-agency/dist;' /etc/nginx/sites-enabled/social-media-agency 2>/dev/null; then
              sed -i 's|root /var/www/social-media-agency/dist;|root /var/www/social-media-agency/public;|' /etc/nginx/sites-enabled/social-media-agency
              echo "Updated nginx root to public/"
            fi
            
            cd backend
            
            # Create .env if it doesn't exist
            if [ ! -f .env ]; then
              echo "Creating .env from template..."
              cp .env.example .env
              echo ".env created"
            fi
            
            # Always update secrets (whether .env existed or not)
            # Use '#' as a separator in sed to avoid issues with special characters in the secret
            sed -i "s#ADMIN_API_KEY=.*#ADMIN_API_KEY=${{ secrets.ADMIN_API_KEY }}#" .env
            sed -i "s/NODE_ENV=.*/NODE_ENV=production/" .env
            echo ".env file updated."

            # Verification step
            echo "Verifying ADMIN_API_KEY..."
            if grep -q "your-secure-api-key-here" .env; then
              echo "Error: ADMIN_API_KEY was not updated correctly!"
              exit 1
            fi
            echo "ADMIN_API_KEY successfully updated."
            grep 'ADMIN_API_KEY' .env
            
            npm ci --omit=dev

            # Debug: Show current directory and env file
            echo "Current directory: $(pwd)"
            echo "Checking .env file..."
            ls -la .env

            # Use full paths to both PM2 and Node.js to avoid PATH issues in non-interactive shell
            echo "Starting PM2 process..."
            /root/.nvm/versions/node/v20.19.6/bin/pm2 delete social-agency-api 2>/dev/null || true
            /root/.nvm/versions/node/v20.19.6/bin/pm2 start dist/server.js --name social-agency-api --interpreter /root/.nvm/versions/node/v20.19.6/bin/node --cwd /var/www/social-media-agency/backend
            /root/.nvm/versions/node/v20.19.6/bin/pm2 save --force
            
            # Verify PM2 started the process
            echo "PM2 process list:"
            /root/.nvm/versions/node/v20.19.6/bin/pm2 list
            
            # Show logs to verify startup
            echo "Recent logs:"
            /root/.nvm/versions/node/v20.19.6/bin/pm2 logs social-agency-api --lines 10 --nostream

            nginx -t && systemctl reload nginx
            echo "Deployed successfully at $(date)"